var X=Object.defineProperty,Y=Object.defineProperties;var tt=Object.getOwnPropertyDescriptors;var N=Object.getOwnPropertySymbols;var et=Object.prototype.hasOwnProperty,nt=Object.prototype.propertyIsEnumerable;var G=(f,h,l)=>h in f?X(f,h,{enumerable:!0,configurable:!0,writable:!0,value:l}):f[h]=l,q=(f,h)=>{for(var l in h||(h={}))et.call(h,l)&&G(f,l,h[l]);if(N)for(var l of N(h))nt.call(h,l)&&G(f,l,h[l]);return f},E=(f,h)=>Y(f,tt(h));import{f as st,s as V,g as O}from"./index.519908f7.js";var A=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function rt(f){throw new Error('Could not dynamically require "'+f+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var K={exports:{}},Q={exports:{}};(function(f,h){(function(l,_){f.exports=_()})(A,function(){var l=l||function(_,B){var m;if(typeof window!="undefined"&&window.crypto&&(m=window.crypto),typeof self!="undefined"&&self.crypto&&(m=self.crypto),typeof globalThis!="undefined"&&globalThis.crypto&&(m=globalThis.crypto),!m&&typeof window!="undefined"&&window.msCrypto&&(m=window.msCrypto),!m&&typeof A!="undefined"&&A.crypto&&(m=A.crypto),!m&&typeof rt=="function")try{m=require("crypto")}catch{}var x=function(){if(m){if(typeof m.getRandomValues=="function")try{return m.getRandomValues(new Uint32Array(1))[0]}catch{}if(typeof m.randomBytes=="function")try{return m.randomBytes(4).readInt32LE()}catch{}}throw new Error("Native crypto module could not be used to get secure random number.")},S=Object.create||function(){function t(){}return function(o){var a;return t.prototype=o,a=new t,t.prototype=null,a}}(),z={},i=z.lib={},D=i.Base=function(){return{extend:function(t){var o=S(this);return t&&o.mixIn(t),(!o.hasOwnProperty("init")||this.init===o.init)&&(o.init=function(){o.$super.init.apply(this,arguments)}),o.init.prototype=o,o.$super=this,o},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var o in t)t.hasOwnProperty(o)&&(this[o]=t[o]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),y=i.WordArray=D.extend({init:function(t,o){t=this.words=t||[],o!=B?this.sigBytes=o:this.sigBytes=t.length*4},toString:function(t){return(t||w).stringify(this)},concat:function(t){var o=this.words,a=t.words,u=this.sigBytes,p=t.sigBytes;if(this.clamp(),u%4)for(var b=0;b<p;b++){var I=a[b>>>2]>>>24-b%4*8&255;o[u+b>>>2]|=I<<24-(u+b)%4*8}else for(var C=0;C<p;C+=4)o[u+C>>>2]=a[C>>>2];return this.sigBytes+=p,this},clamp:function(){var t=this.words,o=this.sigBytes;t[o>>>2]&=4294967295<<32-o%4*8,t.length=_.ceil(o/4)},clone:function(){var t=D.clone.call(this);return t.words=this.words.slice(0),t},random:function(t){for(var o=[],a=0;a<t;a+=4)o.push(x());return new y.init(o,t)}}),g=z.enc={},w=g.Hex={stringify:function(t){for(var o=t.words,a=t.sigBytes,u=[],p=0;p<a;p++){var b=o[p>>>2]>>>24-p%4*8&255;u.push((b>>>4).toString(16)),u.push((b&15).toString(16))}return u.join("")},parse:function(t){for(var o=t.length,a=[],u=0;u<o;u+=2)a[u>>>3]|=parseInt(t.substr(u,2),16)<<24-u%8*4;return new y.init(a,o/2)}},v=g.Latin1={stringify:function(t){for(var o=t.words,a=t.sigBytes,u=[],p=0;p<a;p++){var b=o[p>>>2]>>>24-p%4*8&255;u.push(String.fromCharCode(b))}return u.join("")},parse:function(t){for(var o=t.length,a=[],u=0;u<o;u++)a[u>>>2]|=(t.charCodeAt(u)&255)<<24-u%4*8;return new y.init(a,o)}},c=g.Utf8={stringify:function(t){try{return decodeURIComponent(escape(v.stringify(t)))}catch{throw new Error("Malformed UTF-8 data")}},parse:function(t){return v.parse(unescape(encodeURIComponent(t)))}},d=i.BufferedBlockAlgorithm=D.extend({reset:function(){this._data=new y.init,this._nDataBytes=0},_append:function(t){typeof t=="string"&&(t=c.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(t){var o,a=this._data,u=a.words,p=a.sigBytes,b=this.blockSize,I=b*4,C=p/I;t?C=_.ceil(C):C=_.max((C|0)-this._minBufferSize,0);var R=C*b,T=_.min(R*4,p);if(R){for(var H=0;H<R;H+=b)this._doProcessBlock(u,H);o=u.splice(0,R),a.sigBytes-=T}return new y.init(o,T)},clone:function(){var t=D.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0});i.Hasher=d.extend({cfg:D.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){d.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){t&&this._append(t);var o=this._doFinalize();return o},blockSize:16,_createHelper:function(t){return function(o,a){return new t.init(a).finalize(o)}},_createHmacHelper:function(t){return function(o,a){return new k.HMAC.init(t,a).finalize(o)}}});var k=z.algo={};return z}(Math);return l})})(Q);(function(f,h){(function(l,_){f.exports=_(Q.exports)})(A,function(l){return function(_){var B=l,m=B.lib,x=m.WordArray,S=m.Hasher,z=B.algo,i=[];(function(){for(var c=0;c<64;c++)i[c]=_.abs(_.sin(c+1))*4294967296|0})();var D=z.MD5=S.extend({_doReset:function(){this._hash=new x.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(c,d){for(var k=0;k<16;k++){var t=d+k,o=c[t];c[t]=(o<<8|o>>>24)&16711935|(o<<24|o>>>8)&4278255360}var a=this._hash.words,u=c[d+0],p=c[d+1],b=c[d+2],I=c[d+3],C=c[d+4],R=c[d+5],T=c[d+6],H=c[d+7],W=c[d+8],M=c[d+9],P=c[d+10],j=c[d+11],F=c[d+12],L=c[d+13],U=c[d+14],$=c[d+15],e=a[0],n=a[1],s=a[2],r=a[3];e=y(e,n,s,r,u,7,i[0]),r=y(r,e,n,s,p,12,i[1]),s=y(s,r,e,n,b,17,i[2]),n=y(n,s,r,e,I,22,i[3]),e=y(e,n,s,r,C,7,i[4]),r=y(r,e,n,s,R,12,i[5]),s=y(s,r,e,n,T,17,i[6]),n=y(n,s,r,e,H,22,i[7]),e=y(e,n,s,r,W,7,i[8]),r=y(r,e,n,s,M,12,i[9]),s=y(s,r,e,n,P,17,i[10]),n=y(n,s,r,e,j,22,i[11]),e=y(e,n,s,r,F,7,i[12]),r=y(r,e,n,s,L,12,i[13]),s=y(s,r,e,n,U,17,i[14]),n=y(n,s,r,e,$,22,i[15]),e=g(e,n,s,r,p,5,i[16]),r=g(r,e,n,s,T,9,i[17]),s=g(s,r,e,n,j,14,i[18]),n=g(n,s,r,e,u,20,i[19]),e=g(e,n,s,r,R,5,i[20]),r=g(r,e,n,s,P,9,i[21]),s=g(s,r,e,n,$,14,i[22]),n=g(n,s,r,e,C,20,i[23]),e=g(e,n,s,r,M,5,i[24]),r=g(r,e,n,s,U,9,i[25]),s=g(s,r,e,n,I,14,i[26]),n=g(n,s,r,e,W,20,i[27]),e=g(e,n,s,r,L,5,i[28]),r=g(r,e,n,s,b,9,i[29]),s=g(s,r,e,n,H,14,i[30]),n=g(n,s,r,e,F,20,i[31]),e=w(e,n,s,r,R,4,i[32]),r=w(r,e,n,s,W,11,i[33]),s=w(s,r,e,n,j,16,i[34]),n=w(n,s,r,e,U,23,i[35]),e=w(e,n,s,r,p,4,i[36]),r=w(r,e,n,s,C,11,i[37]),s=w(s,r,e,n,H,16,i[38]),n=w(n,s,r,e,P,23,i[39]),e=w(e,n,s,r,L,4,i[40]),r=w(r,e,n,s,u,11,i[41]),s=w(s,r,e,n,I,16,i[42]),n=w(n,s,r,e,T,23,i[43]),e=w(e,n,s,r,M,4,i[44]),r=w(r,e,n,s,F,11,i[45]),s=w(s,r,e,n,$,16,i[46]),n=w(n,s,r,e,b,23,i[47]),e=v(e,n,s,r,u,6,i[48]),r=v(r,e,n,s,H,10,i[49]),s=v(s,r,e,n,U,15,i[50]),n=v(n,s,r,e,R,21,i[51]),e=v(e,n,s,r,F,6,i[52]),r=v(r,e,n,s,I,10,i[53]),s=v(s,r,e,n,P,15,i[54]),n=v(n,s,r,e,p,21,i[55]),e=v(e,n,s,r,W,6,i[56]),r=v(r,e,n,s,$,10,i[57]),s=v(s,r,e,n,T,15,i[58]),n=v(n,s,r,e,L,21,i[59]),e=v(e,n,s,r,C,6,i[60]),r=v(r,e,n,s,j,10,i[61]),s=v(s,r,e,n,b,15,i[62]),n=v(n,s,r,e,M,21,i[63]),a[0]=a[0]+e|0,a[1]=a[1]+n|0,a[2]=a[2]+s|0,a[3]=a[3]+r|0},_doFinalize:function(){var c=this._data,d=c.words,k=this._nDataBytes*8,t=c.sigBytes*8;d[t>>>5]|=128<<24-t%32;var o=_.floor(k/4294967296),a=k;d[(t+64>>>9<<4)+15]=(o<<8|o>>>24)&16711935|(o<<24|o>>>8)&4278255360,d[(t+64>>>9<<4)+14]=(a<<8|a>>>24)&16711935|(a<<24|a>>>8)&4278255360,c.sigBytes=(d.length+1)*4,this._process();for(var u=this._hash,p=u.words,b=0;b<4;b++){var I=p[b];p[b]=(I<<8|I>>>24)&16711935|(I<<24|I>>>8)&4278255360}return u},clone:function(){var c=S.clone.call(this);return c._hash=this._hash.clone(),c}});function y(c,d,k,t,o,a,u){var p=c+(d&k|~d&t)+o+u;return(p<<a|p>>>32-a)+d}function g(c,d,k,t,o,a,u){var p=c+(d&t|k&~t)+o+u;return(p<<a|p>>>32-a)+d}function w(c,d,k,t,o,a,u){var p=c+(d^k^t)+o+u;return(p<<a|p>>>32-a)+d}function v(c,d,k,t,o,a,u){var p=c+(k^(d|~t))+o+u;return(p<<a|p>>>32-a)+d}B.MD5=S._createHelper(D),B.HmacMD5=S._createHmacHelper(D)}(Math),l.MD5})})(K);var it=K.exports;const Z="db5",ot={operations:[],timeMove:"",timeCars:"",timeIdle:""};function at(f,h){const l=h>>>3,_=h&7;return f[l]&1<<_?1:0}function J(f,h,l){let _=0;for(let B=0;B<l;B++)_|=at(f,h+B)<<B;return _}const ct=st({id:"mainStore",state:()=>({time:"00:00",color:"green",mals:{engine:"\u2014",radio:0,control:!1,nocontrolSwitch:!1,vagonControl:!1,workplace:!1,malfunction:!1,dspstop:!1,soststop:!1,braking:!1},field:V({hash:"",states:"",statesBuffer:new Uint8Array}),in:{type:"\u2014",control:!1,reversor:0,pk:0,kv:0,epk:!1,diesel:!1,rb:!1,boks:!1},sensors:{di_run:0,di_v:0,di_a:0,dd_cyl:0,dd_mag:0,dd_urv:0,dt:0},route:{zones:[{route:"free-way",lastbuid:null,headbuid:null,lightid:0,lightcolor:null,lightunforbid:!1,vagons:0,sd:0,vd:0,vt:0},{route:"free-way",lastbuid:null,headbuid:null,lightid:0,lightcolor:null,lightunforbid:!1,vagons:0,sd:0,vd:0,vt:0}],bu:[]},model:V({id:{},lights:{items:[]},hash:""}),process:ot,buttons:{cruise:!1,pull:!1},plan:{id:"",open:0,operationID:null,stageID:null,operations:[]}}),getters:{getDirection(){return this.sensors.di_v!==0?this.sensors.di_v>0:this.in.reversor>=0},getSpeed(){if(this.route.zones.length>1){const f=this.getDirection?1:0;return{current:Math.round(Math.abs(this.sensors.di_v)),limit:Math.round(this.route.zones[f].vd),target:Math.round(this.route.zones[f].vt)}}return{current:0,limit:0,target:0}},getSignalColor(){if(this.route.zones.length>1){const f=this.getDirection?1:0;return this.route.zones[f].lightcolor||"none"}return"none"},getZoneFront(){if(this.route.zones.length>1){const f=this.route.zones[1].lightid;if(f)return{name:this.model.id[f].name,distance:this.route.zones[1].sd}}return{name:"\u2014",distance:0}},getZoneBack(){if(this.route.zones.length>1){const f=this.route.zones[0].lightid;if(f)return{name:this.model.id[f].name,distance:this.route.zones[0].sd}}return{name:"\u2014",distance:0}}},actions:{updateTime(){const f=new Date;this.time=`${String(f.getHours()).padStart(2,"0")}:${String(f.getMinutes()).padStart(2,"0")}`},openOperation(f){this.plan.open===f?this.plan.open=-1:this.plan.open=f},async fetchCycle(f){try{const{data:h}=await O.get(`/${Z}/now?engines_version=2`),l=h.engines.find(m=>m.mals.engine==f);h.field.hash!==this.model.hash&&await this.fetchModel(),this.mals.engine=l.mals.engine,l.mals.radio.timeout<=3?this.mals.radio=4:l.mals.radio.timeout<=6?this.mals.radio=3:l.mals.radio.timeout<=9?this.mals.radio=2:l.mals.radio.timeout<=12?this.mals.radio=1:l.mals.radio.timeout<=15&&(this.mals.radio=0),this.mals.control=l.mals.control,this.mals.nocontrolSwitch=l.mals.nocontrol_switch,this.mals.vagonControl=l.mals.vagon_control,this.mals.workplace=l.mals.workplace,this.mals.malfunction=l.mals.malfunction,this.mals.dspstop=l.mals.dspstop,this.mals.soststop=l.mals.soststop,this.mals.braking=l.mals.braking||!1,this.field=E(q({},h.field),{statesBuffer:Uint8Array.from(window.atob(h.field.states),m=>m.charCodeAt(0))}),this.in=l.in,this.sensors=l.sensors,this.route.zones=l.route.zones,this.route.bu.splice(0,this.route.bu.length);let _=null;if(l.route.rails.zone)for(let m=0;m<l.route.rails.zone.length;m++){const x=l.route.rails.zone[m],S=this.model.id[x],{buId:z}=S;let i="noControl";if(z){const{bits:y}=this.model.id[z],g=J(this.field.statesBuffer,y[0],y[1]),w=Boolean(g&1),v=Boolean((g&2)>>1),c=Boolean((g&4)>>2),d=Boolean((g&8)>>3);w?v?i="shunt":c?d?i="train-route":i="route":i="free":i="no-control"}z!==_&&this.route.bu.push({state:i,buId:z});const D=y=>{const{bits:g}=this.model.id[y],w=J(this.field.statesBuffer,g[0],g[1]);let v;switch(w){case 0:v="blue";break;case 1:v="white";break;case 2:v="blue";break;case 3:v="blue";break;case 4:v="red";break;case 5:v="yellow";break;case 6:v="yellow";break;case 7:v="green";break;default:v="blue"}return v};if(S.srcType==="\u0441\u0442\u044B\u043A"){const{srcId:y}=S,g=this.model.lights.items.find(w=>w.jointId===y&&w.railId===x);g&&(this.route.bu[this.route.bu.length-1].srcSignal=D(g.id),this.route.bu[this.route.bu.length-1].srcName=g.name)}if(S.dstType==="\u0441\u0442\u044B\u043A"){const{dstId:y}=S,g=this.model.lights.items.find(w=>w.jointId===y&&w.railId===x);g&&(this.route.bu[this.route.bu.length-1].dstSignal=D(g.id),this.route.bu[this.route.bu.length-1].dstName=g.name)}_=z}l.plan.plan_id!==this.plan.id&&await this.fetchPlan(f),this.plan.operationID=l.plan.oper_id,this.plan.stageID=l.plan.stage_id;let B=!0;for(let m=0;m<this.plan.operations.length;m++){const x=this.plan.operations[m];for(let S=0;S<x.stages.length;S++){const z=x.stages[S];(this.plan.operationID===null||z.id===this.plan.stageID)&&(B=!1,x.progress=((S+1)/x.stages.length-.5/x.stages.length)*100),z.finished=B}x.finished=x.stages[x.stages.length-1].finished,x.finished&&(x.progress=100)}}catch(h){console.log(h)}},async fetchModel(){try{const f=["parks","points","joints","switches","bu","lights","rails"],{data:h}=await O.get(`/${Z}/field/model`);h.hash=it(JSON.stringify(h)).toString(),h.id={},f.forEach(l=>{h[l].items.forEach(_=>{h.id[_.id]=E(q({},_),{objectType:l})})}),this.model=h}catch(f){console.log(f)}},async fetchPlan(f){try{const{data:h}=await O.get(`/db5/plan?engine=${f}`);for(let l=0;l<h.data.operations.length;l++){const _=h.data.operations[l];for(let B=0;B<_.stages.length;B++){const m=_.stages[B];m.finished=!1}_.finished=!1}this.plan.id=h.data.id,this.plan.operations.splice(0,this.plan.operations),this.plan.operations=h.data.operations}catch(h){console.log(h)}}}});export{ct as u};
