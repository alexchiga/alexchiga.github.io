var Y=Object.defineProperty,N=Object.defineProperties;var tt=Object.getOwnPropertyDescriptors;var Z=Object.getOwnPropertySymbols;var et=Object.prototype.hasOwnProperty,nt=Object.prototype.propertyIsEnumerable;var G=(a,c,u)=>c in a?Y(a,c,{enumerable:!0,configurable:!0,writable:!0,value:u}):a[c]=u,U=(a,c)=>{for(var u in c||(c={}))et.call(c,u)&&G(a,u,c[u]);if(Z)for(var u of Z(c))nt.call(c,u)&&G(a,u,c[u]);return a},q=(a,c)=>N(a,tt(c));import{f as rt,s as V,g as O}from"./index.1c315279.js";var $=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function st(a){throw new Error('Could not dynamically require "'+a+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Q={exports:{}},X={exports:{}};(function(a,c){(function(u,f){a.exports=f()})($,function(){var u=u||function(f,B){var p;if(typeof window!="undefined"&&window.crypto&&(p=window.crypto),typeof self!="undefined"&&self.crypto&&(p=self.crypto),typeof globalThis!="undefined"&&globalThis.crypto&&(p=globalThis.crypto),!p&&typeof window!="undefined"&&window.msCrypto&&(p=window.msCrypto),!p&&typeof $!="undefined"&&$.crypto&&(p=$.crypto),!p&&typeof st=="function")try{p=require("crypto")}catch{}var b=function(){if(p){if(typeof p.getRandomValues=="function")try{return p.getRandomValues(new Uint32Array(1))[0]}catch{}if(typeof p.randomBytes=="function")try{return p.randomBytes(4).readInt32LE()}catch{}}throw new Error("Native crypto module could not be used to get secure random number.")},h=Object.create||function(){function e(){}return function(o){var l;return e.prototype=o,l=new e,e.prototype=null,l}}(),D={},t=D.lib={},E=t.Base=function(){return{extend:function(e){var o=h(this);return e&&o.mixIn(e),(!o.hasOwnProperty("init")||this.init===o.init)&&(o.init=function(){o.$super.init.apply(this,arguments)}),o.init.prototype=o,o.$super=this,o},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var o in e)e.hasOwnProperty(o)&&(this[o]=e[o]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),y=t.WordArray=E.extend({init:function(e,o){e=this.words=e||[],o!=B?this.sigBytes=o:this.sigBytes=e.length*4},toString:function(e){return(e||k).stringify(this)},concat:function(e){var o=this.words,l=e.words,g=this.sigBytes,m=e.sigBytes;if(this.clamp(),g%4)for(var w=0;w<m;w++){var F=l[w>>>2]>>>24-w%4*8&255;o[g+w>>>2]|=F<<24-(g+w)%4*8}else for(var C=0;C<m;C+=4)o[g+C>>>2]=l[C>>>2];return this.sigBytes+=m,this},clamp:function(){var e=this.words,o=this.sigBytes;e[o>>>2]&=4294967295<<32-o%4*8,e.length=f.ceil(o/4)},clone:function(){var e=E.clone.call(this);return e.words=this.words.slice(0),e},random:function(e){for(var o=[],l=0;l<e;l+=4)o.push(b());return new y.init(o,e)}}),_=D.enc={},k=_.Hex={stringify:function(e){for(var o=e.words,l=e.sigBytes,g=[],m=0;m<l;m++){var w=o[m>>>2]>>>24-m%4*8&255;g.push((w>>>4).toString(16)),g.push((w&15).toString(16))}return g.join("")},parse:function(e){for(var o=e.length,l=[],g=0;g<o;g+=2)l[g>>>3]|=parseInt(e.substr(g,2),16)<<24-g%8*4;return new y.init(l,o/2)}},x=_.Latin1={stringify:function(e){for(var o=e.words,l=e.sigBytes,g=[],m=0;m<l;m++){var w=o[m>>>2]>>>24-m%4*8&255;g.push(String.fromCharCode(w))}return g.join("")},parse:function(e){for(var o=e.length,l=[],g=0;g<o;g++)l[g>>>2]|=(e.charCodeAt(g)&255)<<24-g%4*8;return new y.init(l,o)}},d=_.Utf8={stringify:function(e){try{return decodeURIComponent(escape(x.stringify(e)))}catch{throw new Error("Malformed UTF-8 data")}},parse:function(e){return x.parse(unescape(encodeURIComponent(e)))}},v=t.BufferedBlockAlgorithm=E.extend({reset:function(){this._data=new y.init,this._nDataBytes=0},_append:function(e){typeof e=="string"&&(e=d.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(e){var o,l=this._data,g=l.words,m=l.sigBytes,w=this.blockSize,F=w*4,C=m/F;e?C=f.ceil(C):C=f.max((C|0)-this._minBufferSize,0);var I=C*w,z=f.min(I*4,m);if(I){for(var A=0;A<I;A+=w)this._doProcessBlock(g,A);o=g.splice(0,I),l.sigBytes-=z}return new y.init(o,z)},clone:function(){var e=E.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});t.Hasher=v.extend({cfg:E.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){v.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){e&&this._append(e);var o=this._doFinalize();return o},blockSize:16,_createHelper:function(e){return function(o,l){return new e.init(l).finalize(o)}},_createHmacHelper:function(e){return function(o,l){return new S.HMAC.init(e,l).finalize(o)}}});var S=D.algo={};return D}(Math);return u})})(X);(function(a,c){(function(u,f){a.exports=f(X.exports)})($,function(u){return function(f){var B=u,p=B.lib,b=p.WordArray,h=p.Hasher,D=B.algo,t=[];(function(){for(var d=0;d<64;d++)t[d]=f.abs(f.sin(d+1))*4294967296|0})();var E=D.MD5=h.extend({_doReset:function(){this._hash=new b.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(d,v){for(var S=0;S<16;S++){var e=v+S,o=d[e];d[e]=(o<<8|o>>>24)&16711935|(o<<24|o>>>8)&4278255360}var l=this._hash.words,g=d[v+0],m=d[v+1],w=d[v+2],F=d[v+3],C=d[v+4],I=d[v+5],z=d[v+6],A=d[v+7],R=d[v+8],H=d[v+9],T=d[v+10],W=d[v+11],M=d[v+12],P=d[v+13],j=d[v+14],L=d[v+15],n=l[0],r=l[1],s=l[2],i=l[3];n=y(n,r,s,i,g,7,t[0]),i=y(i,n,r,s,m,12,t[1]),s=y(s,i,n,r,w,17,t[2]),r=y(r,s,i,n,F,22,t[3]),n=y(n,r,s,i,C,7,t[4]),i=y(i,n,r,s,I,12,t[5]),s=y(s,i,n,r,z,17,t[6]),r=y(r,s,i,n,A,22,t[7]),n=y(n,r,s,i,R,7,t[8]),i=y(i,n,r,s,H,12,t[9]),s=y(s,i,n,r,T,17,t[10]),r=y(r,s,i,n,W,22,t[11]),n=y(n,r,s,i,M,7,t[12]),i=y(i,n,r,s,P,12,t[13]),s=y(s,i,n,r,j,17,t[14]),r=y(r,s,i,n,L,22,t[15]),n=_(n,r,s,i,m,5,t[16]),i=_(i,n,r,s,z,9,t[17]),s=_(s,i,n,r,W,14,t[18]),r=_(r,s,i,n,g,20,t[19]),n=_(n,r,s,i,I,5,t[20]),i=_(i,n,r,s,T,9,t[21]),s=_(s,i,n,r,L,14,t[22]),r=_(r,s,i,n,C,20,t[23]),n=_(n,r,s,i,H,5,t[24]),i=_(i,n,r,s,j,9,t[25]),s=_(s,i,n,r,F,14,t[26]),r=_(r,s,i,n,R,20,t[27]),n=_(n,r,s,i,P,5,t[28]),i=_(i,n,r,s,w,9,t[29]),s=_(s,i,n,r,A,14,t[30]),r=_(r,s,i,n,M,20,t[31]),n=k(n,r,s,i,I,4,t[32]),i=k(i,n,r,s,R,11,t[33]),s=k(s,i,n,r,W,16,t[34]),r=k(r,s,i,n,j,23,t[35]),n=k(n,r,s,i,m,4,t[36]),i=k(i,n,r,s,C,11,t[37]),s=k(s,i,n,r,A,16,t[38]),r=k(r,s,i,n,T,23,t[39]),n=k(n,r,s,i,P,4,t[40]),i=k(i,n,r,s,g,11,t[41]),s=k(s,i,n,r,F,16,t[42]),r=k(r,s,i,n,z,23,t[43]),n=k(n,r,s,i,H,4,t[44]),i=k(i,n,r,s,M,11,t[45]),s=k(s,i,n,r,L,16,t[46]),r=k(r,s,i,n,w,23,t[47]),n=x(n,r,s,i,g,6,t[48]),i=x(i,n,r,s,A,10,t[49]),s=x(s,i,n,r,j,15,t[50]),r=x(r,s,i,n,I,21,t[51]),n=x(n,r,s,i,M,6,t[52]),i=x(i,n,r,s,F,10,t[53]),s=x(s,i,n,r,T,15,t[54]),r=x(r,s,i,n,m,21,t[55]),n=x(n,r,s,i,R,6,t[56]),i=x(i,n,r,s,L,10,t[57]),s=x(s,i,n,r,z,15,t[58]),r=x(r,s,i,n,P,21,t[59]),n=x(n,r,s,i,C,6,t[60]),i=x(i,n,r,s,W,10,t[61]),s=x(s,i,n,r,w,15,t[62]),r=x(r,s,i,n,H,21,t[63]),l[0]=l[0]+n|0,l[1]=l[1]+r|0,l[2]=l[2]+s|0,l[3]=l[3]+i|0},_doFinalize:function(){var d=this._data,v=d.words,S=this._nDataBytes*8,e=d.sigBytes*8;v[e>>>5]|=128<<24-e%32;var o=f.floor(S/4294967296),l=S;v[(e+64>>>9<<4)+15]=(o<<8|o>>>24)&16711935|(o<<24|o>>>8)&4278255360,v[(e+64>>>9<<4)+14]=(l<<8|l>>>24)&16711935|(l<<24|l>>>8)&4278255360,d.sigBytes=(v.length+1)*4,this._process();for(var g=this._hash,m=g.words,w=0;w<4;w++){var F=m[w];m[w]=(F<<8|F>>>24)&16711935|(F<<24|F>>>8)&4278255360}return g},clone:function(){var d=h.clone.call(this);return d._hash=this._hash.clone(),d}});function y(d,v,S,e,o,l,g){var m=d+(v&S|~v&e)+o+g;return(m<<l|m>>>32-l)+v}function _(d,v,S,e,o,l,g){var m=d+(v&e|S&~e)+o+g;return(m<<l|m>>>32-l)+v}function k(d,v,S,e,o,l,g){var m=d+(v^S^e)+o+g;return(m<<l|m>>>32-l)+v}function x(d,v,S,e,o,l,g){var m=d+(S^(v|~e))+o+g;return(m<<l|m>>>32-l)+v}B.MD5=h._createHelper(E),B.HmacMD5=h._createHmacHelper(E)}(Math),u.MD5})})(Q);var it=Q.exports;const J="db5",ut={operations:[],timeMove:"",timeCars:"",timeIdle:""};function ot(a,c){const u=c>>>3,f=c&7;return a[u]&1<<f?1:0}function K(a,c,u){let f=0;for(let B=0;B<u;B++)f|=ot(a,c+B)<<B;return f}const ct=rt({id:"mainStore",state:()=>({time:"00:00",color:"green",mals:{engine:"\u2014",radio:0,control:!1,nocontrolSwitch:!1,vagonControl:!1,workplace:!1,malfunction:!1,dspstop:!1,soststop:!1,braking:!1},field:V({hash:"",states:"",statesBuffer:new Uint8Array}),in:{type:"\u2014",control:!1,reversor:0,pk:0,kv:0,epk:!1,diesel:!1,rb:!1,boks:!1},sensors:{di_run:0,di_v:0,di_a:0,dd_cyl:0,dd_mag:0,dd_urv:0,dt:0},route:{zones:[],bu:[]},model:V({id:{},lights:{items:[]},hash:""}),process:ut,buttons:{cruise:!1,pull:!1},plan:{id:"",open:0,operationID:null,stageID:null,operations:[]},windows:{engines:!1,call:!1},engines:[]}),getters:{getDirection(){return this.sensors.di_v!==0?this.sensors.di_v>0:this.in.reversor>=0},getSpeed(){if(this.route.zones.length>1){const a=this.getDirection?1:0;return{current:Math.round(Math.abs(this.sensors.di_v)),limit:Math.round(this.route.zones[a].vd),target:Math.round(this.route.zones[a].vt)}}return{current:0,limit:0,target:0}},getSignalColorByID:a=>c=>{let u="none";if(a.model.id[c]&&a.model.id){const{bits:f}=a.model.id[c];switch(K(a.field.statesBuffer,f[0],f[1])){case 0:u="blue";break;case 1:u="white";break;case 2:u="blue";break;case 3:u="blue";break;case 4:u="red";break;case 5:u="yellow";break;case 6:u="yellow";break;case 7:u="green";break;default:u="blue"}}return u},getSignalColor(){if(this.route.zones.length>1){const a=this.getDirection?1:0;return this.getSignalColorByID(this.route.zones[a].lightid)}return"none"},getZone:a=>c=>{if(a.route.zones.length>1){const u=(()=>{var b,h;return a.route.zones[c].endtype==="light"?((b=a.model.id[a.route.zones[c].lightid])==null?void 0:b.name)||"?":a.route.zones[c].endtype==="section"&&((h=a.model.id[a.route.zones[c].lastbuid])==null?void 0:h.name)||"?"})();let f="\u2014";const B=a.route.zones[c].sd,p=Math.round(a.route.zones[c].vd);switch(a.route.zones[c].route){case"behind-light":f=`\u0437\u0430 ${u}`;break;case"before-light":f=`\u0434\u043E ${u}`;break;case"shunt-way":f=`\u043D\u0430 \u0437\u0430\u043D\u044F\u0442\u044B\u0439 ${u}`;break;case"deadend":f="\u0432 \u0442\u0443\u043F\u0438\u043A";break;case"free-way":f=`\u043D\u0430 \u043F\u0443\u0442\u044C ${u}`;break;case"span":f="\u043D\u0430 \u043F\u0435\u0440\u0435\u0433\u043E\u043D";break;case"away":f="\u0437\u0430 \u043F\u0440\u0435\u0434\u0435\u043B\u044B";break;case"mount-pull":f=`\u043F\u043E\u0434\u0442\u044F\u0433\u0438\u0432\u0430\u043D\u0438\u0435 ${u}`;break;case"mount-push":f=`\u043D\u0430\u0434\u0432\u0438\u0433 ${u}`;break;case"mount-sort":f=`\u0440\u043E\u0441\u043F\u0443\u0441\u043A ${u}`;break;case"mount-back":f=`\u043E\u0441\u0430\u0436\u0438\u0432\u0430\u043D\u0438\u0435 ${u}`;break;case"none":f="\u043D\u0435\u0442";break;default:f=a.route.zones[c].route}return{text:f,distance:B,limit:p}}return{text:"\u2014",distance:0,limit:0}},getZoneFront(){return this.getZone(1)},getZoneBack(){return this.getZone(0)}},actions:{updateTime(){const a=new Date;this.time=`${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`},openOperation(a){this.plan.open===a?this.plan.open=-1:this.plan.open=a},async fetchCycle(a){try{const{data:c}=await O.get(`/${J}/now?engines_version=2`),u=c.engines.find(p=>p.mals.engine==a);c.field.hash!==this.model.hash&&await this.fetchModel(),this.mals.engine=u.mals.engine,u.mals.radio.timeout<=3?this.mals.radio=4:u.mals.radio.timeout<=6?this.mals.radio=3:u.mals.radio.timeout<=9?this.mals.radio=2:u.mals.radio.timeout<=12?this.mals.radio=1:u.mals.radio.timeout<=15&&(this.mals.radio=0),this.mals.control=u.mals.control,this.mals.nocontrolSwitch=u.mals.nocontrol_switch,this.mals.vagonControl=u.mals.vagon_control,this.mals.workplace=u.mals.workplace,this.mals.malfunction=u.mals.malfunction,this.mals.dspstop=u.mals.dspstop,this.mals.soststop=u.mals.soststop,this.mals.braking=u.mals.braking||!1,this.field=q(U({},c.field),{statesBuffer:Uint8Array.from(window.atob(c.field.states),p=>p.charCodeAt(0))}),this.in=u.in,this.sensors=u.sensors,this.route.zones=u.route.zones,this.route.bu.splice(0,this.route.bu.length);let f=null;if(u.route.rails.zone)for(let p=0;p<u.route.rails.zone.length;p++){const b=u.route.rails.zone[p],h=this.model.id[b],{buId:D}=h;let t="noControl";if(D){const{bits:E}=this.model.id[D],y=K(this.field.statesBuffer,E[0],E[1]),_=Boolean(y&1),k=Boolean((y&2)>>1),x=Boolean((y&4)>>2),d=Boolean((y&8)>>3);_?k?t="shunt":x?d?t="train-route":t="route":t="free":t="no-control"}if(D!==f&&this.route.bu.push({state:t,buId:D,length:0,headSrc:null,headDst:null,engine:null}),b===u.route.rails.head_dst[0]&&(this.route.bu[this.route.bu.length-1].headDst=u.route.rails.head_dst[1]+this.route.bu[this.route.bu.length-1].length),b===u.route.rails.head_src[0]&&(this.route.bu[this.route.bu.length-1].headSrc=u.route.rails.head_src[1]+this.route.bu[this.route.bu.length-1].length),b===u.position.railid&&(this.route.bu[this.route.bu.length-1].engine=u.position.raildist+this.route.bu[this.route.bu.length-1].length),this.route.bu[this.route.bu.length-1].length+=h.length,h.srcType==="\u0441\u0442\u044B\u043A"){const{srcId:E}=h,y=this.model.lights.items.find(_=>_.jointId===E&&_.railId===b);y&&(this.route.bu[this.route.bu.length-1].srcSignal=this.getSignalColorByID(y.id),this.route.bu[this.route.bu.length-1].srcName=y.name)}if(h.dstType==="\u0441\u0442\u044B\u043A"){const{dstId:E}=h,y=this.model.lights.items.find(_=>_.jointId===E&&_.railId===b);y&&(this.route.bu[this.route.bu.length-1].dstSignal=this.getSignalColorByID(y.id),this.route.bu[this.route.bu.length-1].dstName=y.name)}f=D}u.plan.plan_id!==this.plan.id&&await this.fetchPlan(a),this.plan.operationID=u.plan.oper_id,this.plan.stageID=u.plan.stage_id;let B=!0;for(let p=0;p<this.plan.operations.length;p++){const b=this.plan.operations[p];for(let h=0;h<b.stages.length;h++){const D=b.stages[h];(this.plan.operationID===null||D.id===this.plan.stageID)&&(B=!1,b.progress=((h+1)/b.stages.length-.5/b.stages.length)*100),D.finished=B}b.finished=b.stages[b.stages.length-1].finished,b.finished&&(b.progress=100)}this.engines.splice(0,this.engines.length),c.engines.forEach(p=>{this.engines.push(p.mals.engine)})}catch(c){console.log(c)}},async fetchModel(){try{const a=["parks","points","joints","switches","bu","lights","rails"],{data:c}=await O.get(`/${J}/field/model`);c.hash=it(JSON.stringify(c)).toString(),c.id={},a.forEach(u=>{c[u].items.forEach(f=>{c.id[f.id]=q(U({},f),{objectType:u})})}),this.model=c}catch(a){console.log(a)}},async fetchPlan(a){var c,u,f,B;try{const{data:p}=await O.get(`/db5/plan?engine=${a}`);for(let b=0;b<p.data.operations.length;b++){const h=p.data.operations[b];switch(h.type){case"arrival":h.text="\u041F\u0440\u0438\u0431\u044B\u0442\u0438\u0435";break;case"departure":h.text="\u041E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435";break;case"cars_coupling":h.text="\u041F\u0440\u0438\u0446\u0435\u043F\u043A\u0430 \u0432\u0430\u0433\u043E\u043D\u043E\u0432";break;case"cars_uncoupling":h.text="\u041E\u0442\u0446\u0435\u043F\u043A\u0430 \u0432\u0430\u0433\u043E\u043D\u043E\u0432";break;case"engine_coupling":h.text="\u041F\u0440\u0438\u0446\u0435\u043F\u043A\u0430 \u043B\u043E\u043A\u043E\u043C\u043E\u0442\u0438\u0432\u0430";break;case"engine_uncoupling":h.text="\u041E\u0442\u0446\u0435\u043F\u043A\u0430 \u043B\u043E\u043A\u043E\u043C\u043E\u0442\u0438\u0432\u0430";break;case"forming":h.text="\u0424\u043E\u0440\u043C\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435";break;case"splitting":h.text=`\u0420\u0430\u0441\u0444\u043E\u0440\u043C\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0441\u043E\u0441\u0442\u0430\u0432\u0430 \u0438\u0437 \u043F\u0430\u0440\u043A\u0430 ${h.yardFrom} c \u043F\u0443\u0442\u0438 ${h.wayFrom} \u0432 \u043F\u0430\u0440\u043A ${h.yardWhere}`;break;case"feeding":h.text="\u041F\u043E\u0434\u0430\u0447\u0430";break;case"picking":h.text="\u0423\u0431\u043E\u0440\u043A\u0430";break;case"placement":h.text="\u0412\u044B\u0441\u0442\u0430\u0432\u043A\u0430";break;case"relocation":h.text="\u041F\u0435\u0440\u0435\u0441\u0442\u0430\u043D\u043E\u0432\u043A\u0430";break;default:h.text=h.type}for(let D=0;D<h.stages.length;D++){const t=h.stages[D];switch(t.type){case"coupling":t.text="\u0421\u0446\u0435\u043F\u043A\u0430";break;case"uncoupling":t.text="\u041E\u0442\u0446\u0435\u043F\u043A\u0430";break;case"route":t.text="\u041C\u0430\u0440\u0448\u0440\u0443\u0442",(c=t.bu_id)!=null&&c.start&&(t.text+=` c ${(u=t.bu_id)==null?void 0:u.start}`),(f=t.bu_id)!=null&&f.end&&(t.text+=` \u043D\u0430 ${(B=t.bu_id)==null?void 0:B.end}`);break;case"idle":t.text="\u041E\u0436\u0438\u0434\u0430\u043D\u0438\u0435";break;case"pulling":t.text="\u041F\u043E\u0434\u0442\u044F\u0433\u0438\u0432\u0430\u043D\u0438\u0435";break;case"thrust":t.text="\u041D\u0430\u0434\u0432\u0438\u0433";break;case"dissolution":t.text="\u0420\u043E\u0441\u043F\u0443\u0441\u043A";break;default:t.text=t.type}if(t.route_type==="before_light"&&t.light_id){const E=this.model.id[t.light_id];E&&E.name&&(t.text+=` \u0434\u043E ${E.name}`)}t.finished=!1}h.finished=!1}this.plan.id=p.data.id,this.plan.operations.splice(0,this.plan.operations),this.plan.operations=p.data.operations}catch(p){console.log(p)}}}});export{ct as u};
